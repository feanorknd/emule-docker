[supervisord]
nodaemon=true

; 1) Xvfb (pantalla fija) — usa DISPLAY_BIT=24
[program:X11]
command=/usr/bin/Xvfb :0 -screen 0 %(ENV_DISPLAY_WIDTH)sx%(ENV_DISPLAY_HEIGHT)sx%(ENV_DISPLAY_BIT)s -dpi %(ENV_DISPLAY_DPI)s -listen tcp -ac
priority=1
startsecs=5
autorestart=true
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
redirect_stderr=true

; 2) fluxbox (WM)
[program:fluxbox]
command=/usr/bin/fluxbox
priority=2
startsecs=8
autorestart=true
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
redirect_stderr=true

; 3) x11vnc (flags para input correcto en Wine y diálogos)
[program:x11vnc]
command=/usr/bin/x11vnc -display :0 -shared -forever -xkb -repeat -noxrecord -noxfixes -nowf -nosel -cursor arrow -wait 5
priority=3
startsecs=12
autorestart=true
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
redirect_stderr=true

; 4) noVNC
[program:novnc]
command=/noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 8080
priority=4
startsecs=14
autorestart=true
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
redirect_stderr=true

; 5) Clipboard (opcional)
[program:autocutsel-clipboard]
command=/usr/bin/autocutsel -verbose
environment=DISPLAY=":0"
priority=5
startsecs=2
autorestart=true
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
redirect_stderr=true

[program:autocutsel-primary]
command=/usr/bin/autocutsel -selection PRIMARY -verbose
environment=DISPLAY=":0"
priority=6
startsecs=2
autorestart=true
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
redirect_stderr=true

; 6) eMule (Wine en desktop virtual del tamaño de Xvfb)
[program:emule]
command=/usr/sbin/gosu emule /usr/bin/wine explorer /desktop=Emule,%(ENV_DISPLAY_WIDTH)sx%(ENV_DISPLAY_HEIGHT)s /app/emule.exe
directory=/app
priority=10
startsecs=18
startretries=10
autorestart=true
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
redirect_stderr=true

; 7) Listener: si emule muere inesperadamente, apagar supervisord (y Docker lo reinicia)
[eventlistener:die_on_emule_failure]
command=/app/die-on-failure.sh emule
events=PROCESS_STATE_EXITED,PROCESS_STATE_FATAL
buffer_size=1024
priority=99
autorestart=true
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
